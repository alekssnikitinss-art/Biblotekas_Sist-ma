<!doctype html>
<html lang="lv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BibliotÄ“ka â€” User</title>
  <link rel="stylesheet" href="stylessheet/style.css">
  <style>
    .container{max-width:900px;margin:20px auto;padding:10px}
    .book{border:1px solid #ddd;padding:8px;margin:8px 0;display:flex;gap:12px}
    .book img{width:80px;height:100px;object-fit:cover}
    .auth-container { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; background: #f0f4f8; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
    .auth-box { background: white; padding: 16px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .auth-buttons { display: flex; gap: 8px; margin-top: 8px; }
    .auth-buttons button { flex:1; padding: 9px 12px; border:none; border-radius:8px; cursor:pointer; }
    #btn-login { background:#2563eb; color:white; }
    #btn-logout { background:#ef4444; color:white; display:none; }
    .books-section{margin-top:30px;}
    @media(max-width:700px){.auth-container{grid-template-columns:1fr;}}
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>BibliotÄ“ka â€” LietotÄja skats</h1>
    <nav>
      <a href="index.html">Guest</a>
      <a href="user.html">User</a>
    </nav>
  </header>

  <!-- Auth Section -->
  <div class="auth-container">
    <div class="auth-box">
      <h4>ğŸ“ ReÄ£istrÄcija</h4>
      <input id="reg-username" placeholder="LietotÄjvÄrds" />
      <input id="reg-password" type="password" placeholder="Parole" />
      <button id="btn-register">ReÄ£istrÄ“t</button>
    </div>
    <div class="auth-box">
      <h4>ğŸ” PieslÄ“gÅ¡anÄs</h4>
      <input id="login-username" placeholder="LietotÄjvÄrds" />
      <input id="login-password" type="password" placeholder="Parole" />
      <div class="auth-buttons">
        <button id="btn-login">PieslÄ“gties</button>
        <button id="btn-logout">AtslÄ“gties</button>
      </div>
      <span id="current-user-display"></span>
    </div>
  </div>

  <!-- User Books -->
  <section class="books-section">
    <h2>PieejamÄs grÄmatas</h2>
    <input id="search-user" placeholder="MeklÄ“t..." style="width:100%" />
    <div id="books-user"></div>
  </section>

  <!-- Admin Panel -->
  <section id="admin-section" style="display:none;margin-top:40px;border-top:2px solid #ddd;padding-top:20px;">
    <h2>ğŸ” Admin panelis</h2>

    <h3>Pievienot / RediÄ£Ä“t grÄmatu</h3>
    <input id="book-id" type="hidden" />
    <input id="title" placeholder="Nosaukums" style="width:100%;margin-bottom:8px" />
    <input id="author" placeholder="Autors" style="width:100%;margin-bottom:8px" />
    <input id="isbn" placeholder="ISBN" style="width:100%;margin-bottom:8px" />
    <input id="image-file" type="file" accept="image/png,image/jpeg" style="margin-bottom:8px" />
    <div style="margin-bottom:12px">
      <button id="btn-add" style="background:#16a34a;margin-right:8px">âœ“ Pievienot/AtjauninÄt</button>
      <button id="btn-clear" style="background:#9ca3af">NotÄ«rÄ«t</button>
    </div>

    <h3>Visas grÄmatas (Admin pÄrvaldÄ«ba)</h3>
    <div id="books-admin"></div>
  </section>
</div>

<script src="app.js"></script>
<script>
(async function(){
  const currentU = currentUser();
  const loginBtn = document.getElementById('btn-login');
  const logoutBtn = document.getElementById('btn-logout');
  const userDisplay = document.getElementById('current-user-display');
  const adminSec = document.getElementById('admin-section');

  // ja jau pieslÄ“gts
  if(currentU){
    logoutBtn.style.display='inline';
    userDisplay.textContent = `âœ… PieslÄ“gts kÄ: ${currentU.username}`;
    if(currentU.role==='admin') adminSec.style.display='block';
    renderBooksAdmin();
  }

  // register
  document.getElementById('btn-register').onclick = async ()=>{
    const u = document.getElementById('reg-username').value.trim();
    const p = document.getElementById('reg-password').value;
    if(!u||!p){alert('Ievadi lietotÄjvÄrdu un paroli'); return;}
    try{
      await registerUser(u,p);
      alert('ReÄ£istrÄcija veiksmÄ«ga');
      document.getElementById('reg-username').value='';
      document.getElementById('reg-password').value='';
    }catch(e){alert('KÄ¼Å«da: '+e.message);}
  };

  // login
  loginBtn.onclick = async ()=>{
    const u = document.getElementById('login-username').value.trim();
    const p = document.getElementById('login-password').value;
    try{
      const result = await loginUser(u,p);
      alert('PieslÄ“gts âœ…');
      loginBtn.disabled=false;
      document.getElementById('login-username').value='';
      document.getElementById('login-password').value='';
      logoutBtn.style.display='inline';
      userDisplay.textContent = `âœ… PieslÄ“gts kÄ: ${result.user.username}`;
      if(result.user.role==='admin') adminSec.style.display='block';
      renderBooksAdmin();
      renderBooksUser('');
    }catch(e){alert('Nepareizi dati: '+e.message);}
  };

  // logout
  logoutBtn.onclick = ()=>{
    logout();
    logoutBtn.style.display='none';
    userDisplay.textContent='';
    adminSec.style.display='none';
    renderBooksUser('');
  };

  // search
  document.getElementById('search-user').oninput = ()=> renderBooksUser(document.getElementById('search-user').value);

  // add/update book
  document.getElementById('btn-add').onclick = async ()=>{
    const id = document.getElementById('book-id').value;
    const title = document.getElementById('title').value.trim();
    const author = document.getElementById('author').value.trim();
    const isbn = document.getElementById('isbn').value.trim();
    const file = document.getElementById('image-file').files[0];
    let img=null;
    if(!title||!author){alert('Ievadi nosaukumu un autoru'); return;}
    const btnAdd = document.getElementById('btn-add');
    const origText = btnAdd.textContent;
    btnAdd.textContent='â³ SaglabÄ...'; btnAdd.disabled=true;
    try{
      if(file){
        if(file.size>4000000){alert('AttÄ“ls pÄrÄk liels'); btnAdd.textContent=origText; btnAdd.disabled=false; return;}
        img = await fileToDataURL(file);
      }
      if(id){ await updateBook(id,{title,author,isbn,image:img}); }
      else{ await addBook({title,author,isbn,image:img}); }
      alert('GrÄmata saglabÄta âœ…');
      document.getElementById('book-id').value='';
      document.getElementById('title').value='';
      document.getElementById('author').value='';
      document.getElementById('isbn').value='';
      document.getElementById('image-file').value='';
      renderBooksAdmin(); // atjauno admin sarakstu
    }catch(e){alert('KÄ¼Å«da: '+e.message);}
    finally{btnAdd.textContent=origText; btnAdd.disabled=false;}
  };

  // clear
  document.getElementById('btn-clear').onclick=()=>{
    document.getElementById('book-id').value='';
    document.getElementById('title').value='';
    document.getElementById('author').value='';
    document.getElementById('isbn').value='';
    document.getElementById('image-file').value='';
  };

  // initial render
  renderBooksUser('');

})();
</script>
</body>
</html>